<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Routing Dashboard - Puda AI</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: #f5f7fa;
            color: #2c3e50;
            padding: 20px;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header-content {
            flex: 1;
        }
        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }
        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }
        .user-info {
            text-align: right;
        }
        .user-info .username {
            font-size: 1em;
            margin-bottom: 8px;
            opacity: 0.95;
        }
        .user-info .badge {
            display: inline-block;
            background: rgba(255,255,255,0.2);
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.8em;
            margin-right: 5px;
        }
        .btn-logout {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 8px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background 0.2s;
            margin-top: 8px;
        }
        .btn-logout:hover {
            background: rgba(255,255,255,0.3);
        }
        .controls {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        .controls label {
            font-weight: 600;
            margin-right: 5px;
        }
        .controls select, .controls input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .controls button {
            padding: 8px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.2s;
        }
        .controls button:hover {
            background: #5568d3;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            border-left: 4px solid #667eea;
        }
        .stat-card.qc {
            border-left-color: #f39c12;
        }
        .stat-card.manual {
            border-left-color: #e74c3c;
        }
        .stat-card.auto {
            border-left-color: #27ae60;
        }
        .stat-card h3 {
            font-size: 0.9em;
            text-transform: uppercase;
            color: #7f8c8d;
            margin-bottom: 10px;
            font-weight: 600;
        }
        .stat-card .value {
            font-size: 2.5em;
            font-weight: 700;
            color: #2c3e50;
        }
        .stat-card .subtitle {
            font-size: 0.85em;
            color: #95a5a6;
            margin-top: 5px;
        }
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .chart-container {
            background: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .chart-container h2 {
            font-size: 1.2em;
            margin-bottom: 20px;
            color: #2c3e50;
        }
        .chart-wrapper {
            position: relative;
            height: 300px;
        }
        .reasons-table {
            background: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .reasons-table h2 {
            font-size: 1.2em;
            margin-bottom: 20px;
            color: #2c3e50;
        }
        .reasons-table table {
            width: 100%;
            border-collapse: collapse;
        }
        .reasons-table th {
            background: #f8f9fa;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid #e9ecef;
        }
        .reasons-table td {
            padding: 12px;
            border-bottom: 1px solid #e9ecef;
        }
        .reasons-table tr:hover {
            background: #f8f9fa;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #95a5a6;
        }
        .last-updated {
            text-align: center;
            color: #95a5a6;
            font-size: 0.9em;
            margin-top: 20px;
        }
        @media (max-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
            .header h1 {
                font-size: 1.5em;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <h1>ðŸ“Š Routing Dashboard</h1>
            <p>Real-time monitoring of document routing decisions</p>
        </div>
        <div class="user-info" id="userInfo" style="display: none;">
            <div class="username" id="userDisplay"></div>
            <button class="btn-logout" onclick="logout()">Logout</button>
        </div>
    </div>

    <div class="controls">
        <div>
            <label for="daysSelect">Time Range:</label>
            <select id="daysSelect">
                <option value="1">Last 24 hours</option>
                <option value="7" selected>Last 7 days</option>
                <option value="30">Last 30 days</option>
                <option value="90">Last 90 days</option>
            </select>
        </div>
        <div>
            <label for="docTypeFilter">Doc Type:</label>
            <select id="docTypeFilter">
                <option value="">All</option>
                <option value="invoice">Invoice</option>
                <option value="id">ID</option>
                <option value="form">Form</option>
                <option value="letter">Letter</option>
                <option value="unknown">Unknown</option>
            </select>
        </div>
        <div>
            <label for="severityFilter">Severity:</label>
            <select id="severityFilter">
                <option value="">All</option>
                <option value="qc">QC</option>
                <option value="manual">Manual</option>
                <option value="auto">Auto</option>
            </select>
        </div>
        <button onclick="refreshDashboard()">ðŸ”„ Refresh</button>
        <label>
            <input type="checkbox" id="autoRefresh" checked> Auto-refresh (30s)
        </label>
    </div>

    <div class="stats-grid">
        <div class="stat-card">
            <h3>Total Documents</h3>
            <div class="value" id="totalDocs">-</div>
            <div class="subtitle">Processed</div>
        </div>
        <div class="stat-card qc">
            <h3>QC Queue</h3>
            <div class="value" id="qcCount">-</div>
            <div class="subtitle" id="qcPercent">-</div>
        </div>
        <div class="stat-card manual">
            <h3>Manual Review</h3>
            <div class="value" id="manualCount">-</div>
            <div class="subtitle" id="manualPercent">-</div>
        </div>
        <div class="stat-card auto">
            <h3>Auto Processed</h3>
            <div class="value" id="autoCount">-</div>
            <div class="subtitle" id="autoPercent">-</div>
        </div>
    </div>

    <div class="stats-grid">
        <div class="stat-card">
            <h3>Avg Classification Confidence</h3>
            <div class="value" id="avgClassConf">-</div>
        </div>
        <div class="stat-card">
            <h3>Avg Field Confidence</h3>
            <div class="value" id="avgFieldConf">-</div>
        </div>
    </div>

    <div class="charts-grid">
        <div class="chart-container">
            <h2>Severity Distribution</h2>
            <div class="chart-wrapper">
                <canvas id="severityChart"></canvas>
            </div>
        </div>
        <div class="chart-container">
            <h2>Document Types</h2>
            <div class="chart-wrapper">
                <canvas id="docTypeChart"></canvas>
            </div>
        </div>
    </div>

    <div class="chart-container" style="margin-bottom: 30px;">
        <h2>Daily Routing Trends</h2>
        <div class="chart-wrapper" style="height: 400px;">
            <canvas id="trendsChart"></canvas>
        </div>
    </div>

    <div class="reasons-table">
        <h2>Top Routing Reasons</h2>
        <table>
            <thead>
                <tr>
                    <th>#</th>
                    <th>Reason</th>
                    <th>Count</th>
                    <th>Percentage</th>
                </tr>
            </thead>
            <tbody id="reasonsTableBody">
                <tr><td colspan="4" class="loading">Loading...</td></tr>
            </tbody>
        </table>
    </div>

    <div class="last-updated">
        Last updated: <span id="lastUpdated">-</span>
    </div>

    <script>
        const API_BASE = window.location.origin;
        let charts = {};
        let autoRefreshInterval = null;
        let sessionToken = null;
        let currentUser = null;

        // Check authentication on page load
        function checkAuth() {
            sessionToken = localStorage.getItem('session_token');
            const userStr = localStorage.getItem('user');
            
            if (!sessionToken) {
                // Redirect to login
                window.location.href = '/login.html';
                return false;
            }
            
            if (userStr) {
                currentUser = JSON.parse(userStr);
                displayUserInfo();
            }
            
            // Verify token is still valid
            fetch(`${API_BASE}/api/auth/me`, {
                headers: {
                    'Authorization': `Bearer ${sessionToken}`
                }
            })
            .then(response => {
                if (!response.ok) {
                    // Token invalid, redirect to login
                    localStorage.removeItem('session_token');
                    localStorage.removeItem('user');
                    window.location.href = '/login.html';
                }
                return response.json();
            })
            .then(data => {
                if (data && data.user) {
                    currentUser = data.user;
                    localStorage.setItem('user', JSON.stringify(data.user));
                    displayUserInfo();
                }
            })
            .catch(() => {
                // Network error or invalid token
                localStorage.removeItem('session_token');
                localStorage.removeItem('user');
                window.location.href = '/login.html';
            });
            
            return true;
        }
        
        function displayUserInfo() {
            if (!currentUser) return;
            
            const userInfo = document.getElementById('userInfo');
            const userDisplay = document.getElementById('userDisplay');
            
            const clearanceBadge = `<span class="badge">Clearance ${currentUser.clearance_level}</span>`;
            const roleBadges = currentUser.roles.map(role => 
                `<span class="badge">${role}</span>`
            ).join(' ');
            
            userDisplay.innerHTML = `
                <div><strong>${currentUser.username}</strong> - ${currentUser.department}</div>
                <div>${clearanceBadge} ${roleBadges}</div>
            `;
            userInfo.style.display = 'block';
        }
        
        async function logout() {
            if (!sessionToken) return;
            
            try {
                await fetch(`${API_BASE}/api/auth/logout`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${sessionToken}`
                    }
                });
            } catch (error) {
                console.error('Logout error:', error);
            }
            
            // Clear local storage
            localStorage.removeItem('session_token');
            localStorage.removeItem('user');
            
            // Redirect to login
            window.location.href = '/login.html';
        }
        
        // Add authorization header to all fetch requests
        const originalFetch = window.fetch;
        window.fetch = function(...args) {
            if (sessionToken && args[0].includes('/api/')) {
                args[1] = args[1] || {};
                args[1].headers = args[1].headers || {};
                args[1].headers['Authorization'] = `Bearer ${sessionToken}`;
            }
            return originalFetch.apply(this, args);
        };

        // Initialize charts
        function initCharts() {
            // Severity pie chart
            charts.severity = new Chart(document.getElementById('severityChart'), {
                type: 'doughnut',
                data: {
                    labels: ['QC', 'Manual', 'Auto'],
                    datasets: [{
                        data: [0, 0, 0],
                        backgroundColor: ['#f39c12', '#e74c3c', '#27ae60']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });

            // Doc type bar chart
            charts.docType = new Chart(document.getElementById('docTypeChart'), {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Documents',
                        data: [],
                        backgroundColor: '#667eea'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });

            // Trends line chart
            charts.trends = new Chart(document.getElementById('trendsChart'), {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'QC',
                            data: [],
                            borderColor: '#f39c12',
                            backgroundColor: 'rgba(243, 156, 18, 0.1)',
                            tension: 0.3
                        },
                        {
                            label: 'Manual',
                            data: [],
                            borderColor: '#e74c3c',
                            backgroundColor: 'rgba(231, 76, 60, 0.1)',
                            tension: 0.3
                        },
                        {
                            label: 'Auto',
                            data: [],
                            borderColor: '#27ae60',
                            backgroundColor: 'rgba(39, 174, 96, 0.1)',
                            tension: 0.3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        async function fetchSummary() {
            const days = document.getElementById('daysSelect').value;
            const docType = document.getElementById('docTypeFilter').value;
            const severity = document.getElementById('severityFilter').value;
            
            let url = `${API_BASE}/api/routing/summary?days=${days}`;
            if (docType) url += `&doc_type=${docType}`;
            if (severity) url += `&severity=${severity}`;
            
            const response = await fetch(url);
            return response.json();
        }

        async function fetchTrends() {
            const days = document.getElementById('daysSelect').value;
            const response = await fetch(`${API_BASE}/api/routing/trends?days=${days}`);
            return response.json();
        }

        function updateStats(data) {
            document.getElementById('totalDocs').textContent = data.total;
            
            const qc = data.severity.qc || 0;
            const manual = data.severity.manual || 0;
            const auto = data.severity.auto || 0;
            const total = data.total || 1;
            
            document.getElementById('qcCount').textContent = qc;
            document.getElementById('qcPercent').textContent = `${((qc/total)*100).toFixed(1)}%`;
            
            document.getElementById('manualCount').textContent = manual;
            document.getElementById('manualPercent').textContent = `${((manual/total)*100).toFixed(1)}%`;
            
            document.getElementById('autoCount').textContent = auto;
            document.getElementById('autoPercent').textContent = `${((auto/total)*100).toFixed(1)}%`;
            
            document.getElementById('avgClassConf').textContent = 
                data.avg_classification_confidence !== null ? data.avg_classification_confidence.toFixed(3) : 'N/A';
            document.getElementById('avgFieldConf').textContent = 
                data.avg_field_confidence !== null ? data.avg_field_confidence.toFixed(3) : 'N/A';
        }

        function updateCharts(summaryData, trendsData) {
            // Update severity chart
            charts.severity.data.datasets[0].data = [
                summaryData.severity.qc || 0,
                summaryData.severity.manual || 0,
                summaryData.severity.auto || 0
            ];
            charts.severity.update();

            // Update doc type chart
            const docTypes = Object.entries(summaryData.doc_types || {});
            charts.docType.data.labels = docTypes.map(([name]) => name);
            charts.docType.data.datasets[0].data = docTypes.map(([, count]) => count);
            charts.docType.update();

            // Update trends chart
            const dates = trendsData.trends.map(t => t.date);
            charts.trends.data.labels = dates;
            charts.trends.data.datasets[0].data = trendsData.trends.map(t => t.qc || 0);
            charts.trends.data.datasets[1].data = trendsData.trends.map(t => t.manual || 0);
            charts.trends.data.datasets[2].data = trendsData.trends.map(t => t.auto || 0);
            charts.trends.update();
        }

        function updateReasonsTable(data) {
            const tbody = document.getElementById('reasonsTableBody');
            tbody.innerHTML = '';
            
            if (!data.top_reasons || data.top_reasons.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; color: #95a5a6;">No data</td></tr>';
                return;
            }
            
            const total = data.total;
            data.top_reasons.forEach((item, index) => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${item.reason}</td>
                    <td>${item.count}</td>
                    <td>${((item.count/total)*100).toFixed(1)}%</td>
                `;
            });
        }

        async function refreshDashboard() {
            try {
                const [summaryData, trendsData] = await Promise.all([
                    fetchSummary(),
                    fetchTrends()
                ]);
                
                updateStats(summaryData);
                updateCharts(summaryData, trendsData);
                updateReasonsTable(summaryData);
                
                document.getElementById('lastUpdated').textContent = new Date().toLocaleString();
            } catch (error) {
                console.error('Failed to refresh dashboard:', error);
                alert('Failed to fetch data. Ensure API server is running.');
            }
        }

        function setupAutoRefresh() {
            const checkbox = document.getElementById('autoRefresh');
            if (checkbox.checked) {
                autoRefreshInterval = setInterval(refreshDashboard, 30000);
            } else {
                if (autoRefreshInterval) {
                    clearInterval(autoRefreshInterval);
                    autoRefreshInterval = null;
                }
            }
        }

        // Initialize on load
        window.onload = () => {
            // Check authentication first
            if (!checkAuth()) return;
            
            initCharts();
            refreshDashboard();
            setupAutoRefresh();
            
            // Setup event listeners
            document.getElementById('daysSelect').addEventListener('change', refreshDashboard);
            document.getElementById('docTypeFilter').addEventListener('change', refreshDashboard);
            document.getElementById('severityFilter').addEventListener('change', refreshDashboard);
            document.getElementById('autoRefresh').addEventListener('change', setupAutoRefresh);
        };
    </script>
</body>
</html>
